# Firestore Database Schema

This document describes the Firestore collections and their structure for Prasadam Connect.

## Collections

### 1. `users` Collection

Stores registered user information.

**Document ID**: User's Firebase Auth UID

**Fields**:
- `uid` (string): Firebase Auth UID (same as document ID)
- `name` (string): User's full name
- `email` (string): User's email address (stored in lowercase)
- `phoneNumber` (string): User's phone number in E.164 format (e.g., "+1234567890")
- `address` (string): User's address
- `createdAt` (timestamp): Server timestamp when user was registered
- `updatedAt` (timestamp): Server timestamp when user data was last updated

**Example Document**:
```json
{
  "uid": "firebase-auth-uid-123",
  "name": "John Doe",
  "email": "john@example.com",
  "phoneNumber": "+1234567890",
  "address": "123 Main St, City, State 12345",
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-15T10:30:00Z"
}
```

**Indexes Required**:
- `phoneNumber` (for checking if phone exists)
- `email` (for checking if email exists)

### 2. `loginHistory` Collection

Stores login history records for all users.

**Document ID**: Auto-generated by Firestore

**Fields**:
- `uid` (string): Firebase Auth UID of the user who logged in
- `phoneNumber` (string): Phone number used for login (E.164 format)
- `timestamp` (timestamp): Server timestamp when login occurred
- `userAgent` (string): User agent string from the browser
- `ipAddress` (string): IP address of the user (if available)

**Example Document**:
```json
{
  "uid": "firebase-auth-uid-123",
  "phoneNumber": "+1234567890",
  "timestamp": "2024-01-15T10:35:00Z",
  "userAgent": "Mozilla/5.0...",
  "ipAddress": "192.168.1.1"
}
```

**Indexes Required**:
- Composite index on `uid` (ascending) and `timestamp` (descending) for querying user's login history

## Security Rules

The Firestore security rules are configured in `firestore.rules`:

- **Users**: Users can read and write their own data only
- **Login History**: Users can only read their own login history; only Cloud Functions/Admin SDK can write

## Access Patterns

1. **Check if user exists**: Query `users` collection by `phoneNumber`
2. **Register new user**: Create document in `users` collection with UID as document ID
3. **Record login**: Add document to `loginHistory` collection
4. **Get user profile**: Get document from `users` collection by UID
5. **Get login history**: Query `loginHistory` collection by `uid`, ordered by `timestamp` descending

